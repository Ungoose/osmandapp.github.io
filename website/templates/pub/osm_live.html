<!DOCTYPE html>
<html>
<head>
  <title>OsmAnd Live</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel='stylesheet' href="/css/site.css">
  <link rel='stylesheet' href="/css/report.css">
  <link rel='stylesheet' href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-config" content="/images/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="maincontainer">
  <div class="main">
    <div th:replace="pub/fragments/simple_header :: header('OSMLIVE', 'OSMAND LIVE' ) ">
    </div>
    <div class="nav-holder">
      <ul class="navigation">
        <li class="active"><a data-toggle="tab" href="#information" th:text="#{osmlive_info}">Information</a></li>
        <li><a data-toggle="tab" href="#report" th:text="#{osmlive_contributions}">OSM Contributions</a></li>
        <li><a data-toggle="tab" href="#donate" th:text="#{osmlive_supporters}">Supporters</a></li>
        <li><a data-toggle="tab" href="#recipients" th:text="#{osmlive_recipients}">Recipients</a></li>
      </ul>
    </div>
    <div class="container">
      <div class="tab-content">
        <div class="loading"></div>
        <div id="report" class="tab-pane fade">
          <h2 th:text="#{osmlive_contributions}">OSM Contributions</h2>
          <div class="report-period-group">
            <div class="report-group period">
              <h4 class="vlabel" for="month-selection" th:text="#{osmlive_period}">Report period</h4>
              <div class="styled-select">
                <select class="form-control" id="month-selection"></select>
              </div>
            </div>
            <div class="report-group region">
              <h4 class="vlabel" for="region-selection" th:text="#{osmlive_region}">Region</h4>
              <div class="styled-select">
                <select class="form-control" id="region-selection"></select>
              </div>
            </div>
          </div>
          <div class="report-total-div">
            <div class="overview-body">
              <p class='overview-hint' ><span th:text="#{osmlive_overview}">Overview for</span> <span id="overview-contributors_options">
              </span><span id='overview-id' style="color:black;float:right;"></span></p>
              <div id="report-total" class="infobox"></div>
            </div>
          </div>
          <h4 class="vlabel" for="report-table" id="report-ranking"></h4>
          <table id="report-table" class="table table-bordered" cellspacing="0" width="100%"></table>
          <h4 class="vlabel" for="users-table" id="users-ranking"></h4>
          <div class="table-controls hidden">
            <div class="tc search">
              <input type="search" class="form-control" aria-control="users-table" id="users-table-search" placeholder="Search">
            </div>
            <div class="tc entries">
              <label>
              <span>Show entries</span>
              <div class="styled-select">
                <select name="users-table_length" aria-controls="users-table" class="form-control" id="users-table-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              </label>
            </div>
          </div>
          <table id="users-table" class="table table-bordered" cellspacing="0" width="100%"></table>
        </div>
        <div id="donate" class="tab-pane fade ">
          <h2 th:text="#{osmlive_supporters}">Supporters</h2>
          <div class="supporters-total-holder">
            <div class="report-period-group supporters">
              <div class="report-group period">
                <h4 class="vlabel" for="donate-month-selection" th:text="#{osmlive_period}">Report period</h4>
                <div class="styled-select">
                  <select class="form-control osm-live-month-select" id="donate-month-selection"></select>
                </div>
              </div>
            </div>
            <div class="supporters-total" id="donator-report-total-div">
              <div class="panel-body">
                <p class='overview-hint'><span th:text="#{osmlive_overview}">Overview for</span> <span id="overview-supporters_options"></span><span id='overview-supporters-span' style="color:black;float:right;"></span></p>
                <div id="donator-report-total" class="infobox"></div>
              </div>
            </div>
          </div>
          <h4 class="vlabel" for="support-country-table" id="support-country-table-header" 
          th:text="#{osmlive_supported_countries}">Supported countries</h4>
          <div class="table-controls support-country-controls hidden">
            <div class="tc search">
              <input type="search" class="form-control" aria-control="support-country-table" id="support-country-table-search" placeholder="Search">
            </div>
            <div class="tc entries">
              <label>
              <span>Show entries</span>
              <div class="styled-select">
                <select name="support-country-table_length" aria-controls="support-country-table" class="form-control" id="support-country-table-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              </label>
            </div>
          </div>
          <table id="support-country-table" class="table table-bordered" cellspacing="0" width="100%"></table>
          <h4 class="vlabel" for="support-table" id="support-table-header">OsmAnd Live supporters</h4>
          <div class="table-controls support-controls hidden">
            <div class="tc search">
              <input type="search" class="form-control" aria-control="support-table" id="support-table-search" placeholder="Search">
            </div>
            <div class="tc entries">
              <label>
              <span>Show entries</span>
              <div class="styled-select">
                <select name="support-table_length" aria-controls="support-table" class="form-control" id="support-table-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              </label>
            </div>
          </div>
          <table id="support-table" class="table table-bordered" cellspacing="0" width="100%"></table>
        </div>
        <div id="information" class="tab-pane fade in active">
          <div id="general-info-div">
            <div id="general-info" class="infobox"></div>
          </div>
          <div class="registration recipient-registration" id="recipients-register-div">
            <h4 class="vlabel" for="recipients-register-div">Register as a recipient</h4 >
            <div class="alert alert-danger" role="alert" id="osm_register_failed" style="display:none">
              <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> 
              OSM Authentication has failed.
            </div>
            <div class="alert alert-success" role="alert" id="osm_register_success" style="display:none">
              <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> 
              You successfully registered as a recipient.
            </div>
            <form role="form" action="subscription/register_osm" method="post" id="register_osm">
              <label for="osm_usr">OpenStreetMap nick name (not email):</label>
              <div class="input-holder input-user">
                <input type="text" class="form-control" id="osm_usr" name="osm_usr">
              </div>
              <p class="input-hint">We use OpenStreetMap.org API to access user statistic.</p>
              <label for="osm_pwd">OpenStreetMap password:</label>
              <div class="input-holder input-pass">
                <input type="password" class="form-control" id="osm_pwd" name="osm_pwd">
              </div>
              <p class="input-hint">We use it to verify that account belongs to you and do not store it on our servers.</p>
              <label for="email">Email address:</label>
              <div class="input-holder input-user">
                <input type="text" class="form-control" id="email" name="email">
              </div>
              <p class="input-hint">We can use it to confirm that account doesn't violate TOS.</p>
              <label for="bitcoin_addr">Bitcoin address:</label>
              <div class="input-holder input-bitcoin">
                <input type="text" class="form-control" id="bitcoin_addr" name="bitcoin_addr">
              </div>
              <p class="input-hint">This bitcoin address will be used to transfer funds to.</p>
              
              <div class="input-agree">
                  <input type="checkbox" id="agree_osm_live" name="agree_osm_live">
                  <label for="agree_osm_live" class="agree_osm_live_label">I Agree with OSM Live program</label><a class="vlabel" id="myBtn"> rules.</a>
              </div>
              <button type="submit" class="btn btn-default" id="register_osm_user">Register</button>
              <p style="font-size:12px; line-height:1.3em; padding-top:20px">To update the BTC address follow the registration proccess, to delete the account enter an empty BTC address.</p>
            <!-- The Modal -->
            <div id="myModal" class="modal">
              <!-- Modal content -->
              <div class="modal-content">
                <div class="modal-header">
                  <span class="close-params">&times;</span>
                  <h2>Program Rules</h2>
                </div>
                <div class="modal-body">
                  <p style="font-size:15px; padding-top:20px">By registering, <b>you accept the following:</b>
                    <ul style="font-size:15px; line-height:1.3em;">
                      <li>- The payments made to mappers within OsmAnd Live project are considered donations for their contributions, not remuneration for labor;</li>
                      <li>- OsmAnd is not obliged to make payments; the company can suspend payouts and/or remove accounts of certain users if their work is not beneficial to the project;</li>
                      <li>- The project allows only 1 payment per 1 individual at a time;</li>
                      <li>- The payments can be suspended in case of unexpected emergencies.</li>
                    </ul>
                  </p>
                </div>
              </div>
            </div>
            </form>
          </div>
          <div class="registration contributor-registration" id="contributor-register-div">
            <h4 class="vlabel" for="recipients-register-div">Register as a contributor</h4 >
            <p>If you want to support OSM by purchasing OsmAnd Live Subscription, you can do it directly in the application.</p>
            <div class="registration-badges">
              <a data-gatag="googleplay" href="https://play.google.com/store/apps/details?id=net.osmand.plus"><img alt="Get it on Google Play" src="/images/en-play-badge.png" /></a>
               <a data-gatag="ios" href="https://itunes.apple.com/app/apple-store/id934850257?pt=2123532&amp;ct=WebSite&amp;mt=8"><img src="/images/app-store-badge.png"/></a>
            </div>
            <p>The payouts are distributed based on the ranking which is available in OSM Contributions tab, the last ranking has weight&nbsp;=&nbsp;1, the ranking before the last has weight&nbsp;=&nbsp;2 and so on till the 1st ranking.</p>
            <h5 class="vlabel">Donate without any extra charges:</h5>
            <p>If you want to donate to OsmAnd Live Program where donation will split 50/50 between OsmAnd Team and OSM contributors, please use the following address:</p>
            <div class="btc-address">3MHyi4qtrmaxEy9A336RMwZaYqUzcbF2gr</div>
            <p>If you want to donate only to OsmAnd Team, please use the following address:</p>
            <div class="btc-address">1GRgEnKujorJJ9VBa76g8cp3sfoWtQqSs4</div>
            
            

          </div>
          <div class="full-width-banner">
            <img src="/images/Info_landscape.png" alt="">
          </div>
        </div>
        <div id="recipients" class="tab-pane fade">
          <h2 th:text="#{osmlive_recipients}">Recipients</h2>
          <!--
            <h4 class="vlabel" for="recipients-info-div">Information</h4 >
              <div class="panel panel-default" id="recipients-info-div">
                  <div class="panel-body"><p id="recipients-general-info" class="infobox"></p></div>
              </div>
            <hr>
          -->
          <div class="report-period-group">
            <div class="report-group period">
              <h4 class="vlabel" for="recipient-month-selection" th:text="#{osmlive_period}">Report period</h4>
              <div class="styled-select">
                <select class="form-control osm-live-month-select" id="recipient-month-selection"></select>
              </div>
            </div>
            <div class="report-group region">
              <h4 class="vlabel" for="recipient-region-selection" th:text="#{osmlive_region}">Region</h4>
              <div class="styled-select">
                <select class="form-control" id="recipient-region-selection"></select>
              </div>
            </div>
          </div>
          <div class="report-total-div">
            <div class="overview-body">
              <div id="recipients-data-info" class="infobox">
                  <p class='recipients-data-header overview-hint'>
                        Collected in 
                        <span id='overview-recipients_option'></span> 
                        <span id='recipients-gen-date' style=\"color:black;float:right;\"></span>
                  </p>

                  <div id="recipients-world-collected" class='overview overview-btc'>
                    <p>- mBTC</p><span>total collected (may change in the final report)</span>
                  </div>
                  <div id="recipients-region-collected" class='overview overview-btc' >
                    <p>- mBTC</p><span>collected Worldwide</span>
                  </div>
                  <p id="recipients-payouts" class='recipients-data-header overview-hint'></p>
                  <p id="recipients-reports"></p>
              </div>
            </div>
          </div>
          <!--          <p><b>Important:</b> Registration temporarily suspended. Read <a href="https://www.osmand.net/blog?id=osmand_payouts_suspended_01_2018">this article</a> for more information.</p> -->
          <h4 class="vlabel" for="recipients-table" id="recipients-table-header">OSM Recipients</h4>
          <div class="table-controls recipients-controls hidden">
            <div class="tc search">
              <input type="search" class="form-control" aria-control="recipients-table" id="recipients-table-search" placeholder="Search">
            </div>
            <div class="tc entries">
              <label>
              <span>Show entries</span>
              <div class="styled-select">
                <select name="recipients-table_length" aria-controls="recipients-table" class="form-control" id="recipients-table-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              </label>
            </div>
          </div>
          <table id="recipients-table" class="table table-bordered" cellspacing="0" width="100%"></table>
        </div>
      </div>
    </div>
    <div th:replace="pub/fragments/footer"/>
  </div>
</div>
<script>

// Get the modal
var modal = document.getElementById('myModal');

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close-params")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
  $('body').css('overflow', 'hidden');
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  $('body').css('overflow', 'auto');
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    $('body').css('overflow', 'auto');
    modal.style.display = "none";
  }
}
  $.urlParam = function(name){
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
      if (results==null){
         return null;
      }
      else{
         return results[1] || 0;
      }
  }
  var extended = $.urlParam('full') == 'yes';
  var mid = "";
  var midName = "";
  var supportMonth = "";
  var supportMonthName = "";
  var region = "";
  var regionName = "";
  var regionsmap = {};
  var regionsbydownloadname = {};
  var recipientMonth = "";
  var recipientMonthName = "";
  var recipientRegion = "";
  var recipientRegionName = "";

  var floatFormat = function (o) { 
      var fl = parseFloat(o) * 100;
      return Math.round(fl) / 100.;
  }
  
  function regionDepth(region, regionsmap) {
    if(region.parentid in regionsmap) {
      return regionDepth(regionsmap[region.parentid], regionsmap) + 1;
    } else {
      return 0;
    }
  }
  
  function updateRegions() {
    $('#region-selection').empty();
    $('#recipient-region-selection').empty();
    regionsmap = {};
    regionsbydownloadname = {};
    if(regionName.length > 0 && regionName != "Worldwide") {
      $("#region-selection").append("<option value='"+region+"'>"+regionName+"</option>"); 
    }
    if(recipientRegionName.length > 0 && recipientRegionName != "Worldwide") {
      $("#recipient-region-selection").append("<option value='"+recipientRegion+"'>"+recipientRegionName+"</option>"); 
    }
    $("#region-selection").append("<option value=''>Worldwide</option>"); 
    $("#recipient-region-selection").append("<option value=''>Worldwide</option>"); 
    $.ajax({
        url: "/reports/query_report?report=all_countries", 
        async: true
      }).done(function(res) {
        var data = jQuery.parseJSON( res );
        var namemap = {};
        for(i = 0; i < data.rows.length; i++) {
          var row = data.rows[i];
          regionsmap[data.rows[i].id] = data.rows[i];
          if(row.downloadname && row.map == "1" ) {
            var name = row.name;
            if(row.visiblename) {
                name = row.visiblename;
            } else { 
              var depth = regionDepth(row, regionsmap);
              if(depth > 2 || (depth == 2 && regionsmap[row.parentid].name == "Russia")) {
                var parent = regionsmap[row.parentid];
                var parentparent = regionsmap[parent.parentid];
                if(depth == 3) {
                  if(parentparent.name == "Russia") {
                    name = parentparent.name + " " + name;
                  } else if(parent.name != "United Kingdom"){
                    name = parent.name + " " + name;
                  }
                } else {
                  // only england
                  name = parent.name + " " + name;
                }
              }
            } 
            namemap[name] = row.downloadname;
            regionsbydownloadname[row.downloadname] = name;
          }
      }
      var sorted_keys = Object.keys(namemap).sort()
      for(i = 0; i < sorted_keys.length; i++) {
        $("#region-selection").append("<option value='"+namemap[sorted_keys[i]]+"'>"+sorted_keys[i]+"</option>"); 
        $("#recipient-region-selection").append("<option value='"+namemap[sorted_keys[i]]+"'>"+sorted_keys[i]+"</option>"); 
      }
    });
  }
  
  function updateTotalChanges() {
    $('#report-total').empty();
    if(reportUserDataTable) {
      reportUserDataTable.clear().draw();
    }
    if(reportDataTable) {
      reportDataTable.clear().draw();
    }
    $('#report-ranking').empty();
    $.ajax({
        url: "/reports/query_report?report=all_contributions_requests&month="+mid+"&region="+region, 
        async: true
      }).done(function(res) {
        // var resultArray = res.split("\n");
        var resultArray = jQuery.parseJSON(res);
        var totalChanges = resultArray[0];
        var data = totalChanges; //jQuery.parseJSON( totalChanges );
        var html = "<div class='overview overview-changes'><p>" + data.changes + "</p><span>changes</span></div>" 
          + "<div class='overview overview-users'><p>" + data.users   + "</p><span>contributors</span></div>";
        if(regionName.length > 0) {
           html = html + "<div class='overview overview-region'><p>" + regionName + "</p><span>country</span></div>";
        }
        if (data.date != null || data.date != undefined) {
          //html += "<p class=\"overview-hint\">Generation date: " + "<span id=\"overview-date\">" + data.date + "</span></p>";
          $('#overview-id').html("Generation date <span>"+ formatDate(data.date) + "</span>");
        }
        else {
           $('#overview-id').html("");
        } 
        $('#report-total').html(html);
        setContributorsOverviewHint();
        updateRankingByMonth(resultArray[1]);
        
        if (resultArray.length > 2) {
          updateUserRankingByMonth(resultArray[2]);
        }
    });
  }

  function formatDate(timestampString) {
   var currTime = parseInt(timestampString, 10);
   var currTimeString = (new Date(currTime*1000)).toString();
   return currTimeString.substring(currTimeString.indexOf(" "), currTimeString.lastIndexOf(":"));
  }
  
  
  function countryName(value) {
    if(value == '') {
      return "Worldwide";
    }
    if(value in regionsbydownloadname) {
      return regionsbydownloadname[value];
    }
    return value;
  }
  
  
  var reportRecipientsDataTable;
  var reportRecipientsDataInfo;
  function updateRecipientsByMonth() {
    if(reportRecipientsDataTable && reportRecipientsDataInfo) {
      reportRecipientsDataTable.clear().draw();
      $("#recipients-data-info").html("");
    }
    $.ajax({
          url: "/reports/query_report?report=recipients_by_month&month="+recipientMonth+"&region="+recipientRegion, 
          async: true
    }).done(function(res) {
          var data = jQuery.parseJSON( res );
          var recipients = data;
          //$("#recipients-general-info").html(intro);
          // reportRecipientsDataInfo = $("#recipients-data-info").html(data.message);
          if (recipients.date != null && recipients.date != undefined) {
            $("#recipients-gen-date").html("Generation date " + formatDate(recipients.date));
          } else {
            $("#recipients-gen-date").html("");
          }
          $("#recipients-world-collected").html(data.worldCollectedMessage);
          $("#recipients-region-collected").html(data.regionCollectedMessage +
                  '<span> ' + countryName(recipientRegion)+'</span>');
          $("#recipients-payouts").html(data.payouts);
          $("#recipients-reports").html(data.reports);
          var list = recipients.rows.map(function(key){
              if(recipients.regionTotalWeight > 0) {
                key.percent = key.weight + " / " + recipients.regionTotalWeight ;
              } else {
                key.percent = '';
              }
              key.mbtc = (key.btc * 1000.).toFixed(4)  + " mBTC";
              return key;
          });
          var rowPerPage = function(windowWidth) {
            if (windowWidth < 380) {
              return 10;
            } else if (windowWidth < 650) {
              return 20;
            } else if (windowWidth < 970) {
              return 30;
            } else {
              return 50;
            }
          }
          reportRecipientsDataTable = $('#recipients-table').DataTable({
              data: list,
              destroy: true,
              columns: [
                  { "data": "osmid", title: "OSM ID"},
                  { "data": "changes", title: "OSM Changes"},
                  { "data": "rank", title: "Rank"},
                  { "data": "weight", title: "Weight"},
                  { "data": "percent", title: "Part"},
                  { "data": "mbtc", title: "Sum"},
                  { "data": "btcaddress", title: "Bitcoin Address"}
              ],
              "paging":   true,
              "iDisplayLength": rowPerPage($(window).width()),
              "info":     false,
              "bAutoWidth": false,
              "dom": "tp"
          });
          $('.table-controls.recipients-controls').removeClass('hidden');
          setRecipientOverviewHint();
    });
  }
  

  var reportSupportDataTable;
  var reportSupportCountryDataTable;
  function updateSupportByMonth() {
    if(reportSupportDataTable) {
      reportSupportCountryDataTable.clear().draw();
      reportSupportDataTable.clear().draw();
      $('#donator-report-total').html("");
    }
    $.ajax({
          url: "/reports/query_report?report=supporters_by_month&month="+supportMonth+"&full="+extended, 
          async: true
    }).done(function(res) {
          var data = jQuery.parseJSON( res );
          if(extended) {
            data.rows.push.apply(data.rows, data.notactive)
          }
          if (data.date != null && data.date != undefined) {
            $('#overview-supporters-span').html("Generation date <span>"+ formatDate(data.date) + "</span>");
          } else { 
            $('#overview-supporters-span').html(""); 
          }
          $('#donator-report-total').html("<div class='overview overview-active_supporters'><p>" + data.activeCount + 
              "</p><span>active donors</span></div>" 
              + "<div class='overview overview-register_supporters'><p>" + data.count +"</p><span>registered supporters</span></div>" );
          var regionsList = Object.keys(data.regions).map(function(key){
              data.regions[key].coeff = Math.round(data.regions[key].percent * 10000) / 100 + "%";
              return data.regions[key];
          });
          reportSupportCountryDataTable = $('#support-country-table').DataTable({
            data: regionsList,
              destroy: true,
              columns: [
                  { "data": "name", "title": "Region name"},
                  { "data": "count", "title": "Supported users"},
                  { "data": "coeff", "title": "Percentage"}
              ],
              "paging":   true,
              "iDisplayLength": 50,
              "info":     false,
              "dom": "tp"
          });
          $('.table-controls.support-country-controls').removeClass('hidden');
          reportSupportDataTable = $('#support-table').DataTable({
              data: data.rows,
              destroy: true,
              columns: [
                  { "data": "user", "title": "User name"},
                  { "data": "status", "title": "Status"},
                  { "data": "regionName", "title": "Region", "visible": extended},
              ],
              "paging":   true,
              "ordering": true,
              "iDisplayLength": 50,
              "info":     false,
              "searching": true,
              "dom": "tp"
          });
          $('.table-controls.support-controls').removeClass('hidden');
          setSupportersOverviewHint();
    });
  }
  

  var reportUserDataTable;
  function updateUserRankingByMonth(resource) {
    
    $('#users-ranking').text("Select region to see user statistics ");
  
    if(region.length > 0 ) {
      
          var data = resource;
          $('#users-ranking').text("Ranking of contributors");
          var columns = [
                  { "data": "rank", title: "Region rank"},
                  { "data": "grank", title: "World rank"},
                  { "data": "user", title: "User name"},        
                  { "data": "changes", title: "Changes"}
          ];
          if(mid >= '2018-09') {
              columns.push({ "data": "atomchanges", title: "Objects changed"});
              columns.push({ "data": "globalchanges", title: "Worldwide changes"});
          }
          reportUserDataTable = $('#users-table').DataTable({
              data: data.rows,
              destroy: true,
              columns: columns,
              "paging":   true,
              "ordering": true,
              "iDisplayLength": 50,
              "info":     false,
              "searching": true,
              "dom": 'tp'
          });
          $('.table-controls').removeClass('hidden');

    }
  }

  var reportDataTable;
  function updateRankingByMonth(resource) {
    var data = resource; //jQuery.parseJSON(resource);
    $('#report-ranking').html("Ranking of contributors by " + data.rows.length + " groups <span>(made more than 3 changes)</span>");
    var columns = [
                { "data": "rank", title: "Rank"},
                { "data": "countUsers", title: "Contributors <span>in group</span>"},
                { "data": "minChanges", title: "Minimum changes <span>in group</span>"},
                { "data": "maxChanges", title: "Maximum changes <span>in group</span>"}
    ];
    if(mid >= '2018-09') {
        columns.push({ "data": "totalChanges", title: "Total changes <span>by group</span>"}); //, render:floatFormat
        columns.push({ "data": "atomTotalChanges", title: "Total edited objects <span>by group</span>"});
    }
      reportDataTable = $('#report-table').DataTable({
            data: data.rows,
            destroy: true,
            columns: columns,
            "paging":   false,
            "ordering": true,
            //"iDisplayLength": 20,
            "info":     false,
            "searching": false,
            "dom": "t",
      });
  }

  
  function formatYearMonthHuman(year, month) {
    var monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
    return monthNames[month - 1] + " " + year;
  }
  
  function formatYearMonth(year, month) {
    if(month < 10) {
      return year +"-0" +month;
    } else {
      return year +"-" +month;
    }
  }
  
  function updateGeneralInfo() {
    var responseText;
    var xhttp = new XMLHttpRequest();
    
    xhttp.onreadystatechange = function() {
      var text = "<h2>About OsmAnd Live</h2>" + 
      "<p>OsmAnd relies heavily on OSM and its community. Simply put, OsmAnd wouldn't exist without that great community. "+
      "When we started implementing OsmAnd Live, we immediately decided that it should be not only a paid service, but a donation service as well. " +
      "OsmAnd Live is only possible due to thousands of edits made every hour in many places of the world, which is why we want to distribute a part of the income among OSM editors.</p>" +
      "<h3>How it works</h3><ul>" +
      "<li> Every OSM contributor can be registered as a recipient. They just need to provide a valid Bitcoin address in the form below. " +
      "<li> Every OsmAnd user who wants to get live updates needs to subscribe to that service. " +
      "<li> After Google and Bank deductions the whole sum is split into 2 parts (<strong>50% OsmAnd</strong> and <strong>50% Donations</strong>)"+
      "<li> All donations are exchanged into Bitcoin and distributed between OSM contributors according to their ranking."+
      "<li> Every OsmAnd user can select a preferred donation region, in which case <strong>50% of donations</strong> will be distributed between editors of that region."+
      "</ul><br> Please find all rankings and formulas in the reports on OsmAnd Live. Note that if the Bitcoin transaction cost exceeds 10% of the payment it not be payed immediately, currently it equals 0.5 mBTC (price 1 mBtc/KB, tx size 0.05 KB). Cumulative report on non-paid transactions will be generated monthly on the recipient's page. All pending transactions will be paid once the total sum exceeds 10% fee threshold.";
      if (this.readyState == 4 && this.status == 200) {
        // Typical action to be performed when the document is ready:
         responseText = xhttp.responseText;
          text = text +"<p><br>Current processed OsmAnd Live date: <strong>"+ responseText+ " UTC </strong>";
      }
      $("#general-info").html(text);
   };
   xhttp.open("GET", "/api/osmlive_status", true);
   xhttp.setRequestHeader('Content-Type', 'text/plain');
   xhttp.send();
  }

  function isEmail(emailV) {
    if(emailV != null && emailV != undefined) {
        var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
        return pattern.test(emailV);    
    }
    else{
        return false;
    }
  }
  
  function handleRegisterOsm() {

    $("#register_osm_user").click(function( event ) {
        event.preventDefault();
          // if($("#bitcoin_addr").val() == "") {
          //   $("#osm_register_failed").html("Please specify correct bitcoin address");
          //   $("#osm_register_failed").fadeIn(100);
          //   return;
          // }
          if(!isEmail($("#email").val())) {
            $("#osm_register_failed").html("Please specify a valid email address");
            $("#osm_register_failed").fadeIn(100);
            return;
          }
          if (!$("#agree_osm_live").is(':checked')) {
            $("#osm_register_failed").html("You must agree to the tems of use.");
            $("#osm_register_failed").fadeIn(100);
            return;
          }
  
        $.post("subscription/register_osm", $("#register_osm").serialize(), function(res) {
            if (res == "OK") {
              $("#osm_register_success").fadeIn(100);
            }
            var data = res;
            if (data.error) {
              $("#osm_register_failed").fadeIn(100);
              $("#osm_register_failed").html(data.error);
            } else {
              $("#osm_register_failed").fadeOut(0);
              $("#osm_register_success").fadeIn(100); 
            }
           
        });
    });
  }
  
  function selectProperTab() {
    var url = document.location.toString();
    if (url.match('#')) {
        $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show') ;
    } 
  }
  $(document).ready(function(){
    var currentTime = new Date();
    var month = currentTime.getMonth() + 1;
    var day = currentTime.getDate();
    var year = currentTime.getFullYear();
    mid = formatYearMonth(year, month);
    for(yi = 2016; yi <= year; yi++) {
      stmonth = yi == 2015? 8 : 1;
      endmonth = yi == year? month : 12;
      for(mi = stmonth; mi <= endmonth; mi++) {
        $("#month-selection").prepend("<option value='"+formatYearMonth(yi,mi)+"'"+((mi==endmonth&&yi==year)?' selected':'')+">"+formatYearMonthHuman(yi,mi)+"</option>");
      }
    }
    for(yi = 2016; yi <= year; yi++) {
      stmonth = yi == 2016? 1 : 1;
      endmonth = yi == year? month : 12;
      for(mi = stmonth; mi <= endmonth; mi++) {
        $(".osm-live-month-select").prepend("<option value='"+formatYearMonth(yi,mi)+"'"+((mi==endmonth&&yi==year)?' selected':'')+">"+formatYearMonthHuman(yi,mi)+"</option>");
      }
    }
    if(typeof(Storage) !== "undefined") {
        if(sessionStorage.supportMonth) {
            supportMonth = sessionStorage.supportMonth;
            supportMonthName = sessionStorage.supportMonthName;
            $("#donate-month-selection").val(supportMonth);
            var currentMonth  = $("#donate-month-selection").children("option").filter(":selected").text();
            $('#overview-supporters_options').text(currentMonth);
        }
        if(sessionStorage.recipientMonth) {
            recipientMonth = sessionStorage.recipientMonth;
            recipientMonthName = sessionStorage.recipientMonthName;
            $("#recipient-month-selection").val(recipientMonth);
            var currentMonth  = $("#recipient-month-selection").children("option").filter(":selected").text();
            $('#overview-recipients_option').text(currentMonth);
        }
        if(sessionStorage.recipientRegion) {
            recipientRegion = sessionStorage.recipientRegion;
            recipientRegionName = sessionStorage.recipientRegionName;
            $("#recipient-region-selection").val(recipientRegion);
        }
  
        if(sessionStorage.month) {
            mid = sessionStorage.month;
            midName = sessionStorage.monthName;
            $("#month-selection").val(mid);
        }
        if(sessionStorage.region) {
            region = sessionStorage.region;
            regionName = sessionStorage.regionName;
            $("#region-selection").val(region);
            var currentMonth  = $("#month-selection").children("option").filter(":selected").text(),
                currentRegion = $("#region-selection").children("option").filter(":selected").text();
            $('#overview-contributors_options').text(currentMonth + ', ' + currentRegion);
        }
    }
  
    
    handleRegisterOsm();
    updateRegions();
    updateGeneralInfo();
    updateSupportByMonth();
    updateRecipientsByMonth();
    
    updateTotalChanges();
    //updateRankingByMonth();
    //updateUserRankingByMonth();
    
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        /*var target = $(e.target).attr("href") // activated tab
        window.location.hash = target;*/
        $('.loading').removeClass("active");
        e.preventDefault();
        return false;
    });
    window.onpopstate = function(event) {
      selectProperTab();
    };
    selectProperTab();
  
    $('#donate-month-selection').on('change', function (e) {
        if (!$('#information').is(':visible')) {
          $('.loading').addClass("active");
        }
        var optionSelected = $("option:selected", this);
        supportMonth = this.value;
        supportMonthName = optionSelected.text();
        if(typeof(Storage) !== "undefined") {
          sessionStorage.supportMonth = supportMonth;
          sessionStorage.supportMonthName = supportMonthName;
        }
        updateSupportByMonth();
        setSupportersOverviewHint();
    });
    $('#recipient-month-selection').on('change', function (e) {
        if (!$('#information').is(':visible')) {
          $('.loading').addClass("active");
        }
        var optionSelected = $("option:selected", this);
        recipientMonth = this.value;
        recipientMonthName = optionSelected.text();
        if(typeof(Storage) !== "undefined") {
          sessionStorage.recipientMonth = recipientMonth;
          sessionStorage.recipientMonthName = recipientMonthName;
        }
        updateRecipientsByMonth();
        setRecipientOverviewHint();
    });
    $('#recipient-region-selection').on('change', function (e) {
        if (!$('#information').is(':visible')) {
          $('.loading').addClass("active");
        }
        var optionSelected = $("option:selected", this);
        recipientRegion = this.value;
        recipientRegionName = optionSelected.text();
        if(typeof(Storage) !== "undefined") {
          sessionStorage.recipientRegion = recipientRegion;
          sessionStorage.recipientRegionName = recipientRegionName;
        }
        updateRecipientsByMonth();
      });
    
    $('#month-selection').on('change', function (e) {
        if (!$('#information').is(':visible')) {
          $('.loading').addClass("active");
        }
        var optionSelected = $("option:selected", this);
        mid = this.value;
        midName = optionSelected.text();
        if(typeof(Storage) !== "undefined") {
          sessionStorage.month = mid;
          sessionStorage.monthName = midName;
        }
        updateTotalChanges();
        //updateRankingByMonth();
        //updateUserRankingByMonth();
        setContributorsOverviewHint();
    });
  
    $('#region-selection').on('change', function (e) {
        if (!$('#information').is(':visible')) {
          $('.loading').addClass("active");
        }
        var optionSelected = $("option:selected", this);
        region = this.value;
        regionName = optionSelected.text();
        if(typeof(Storage) !== "undefined") {
          sessionStorage.region = region;
          sessionStorage.regionName = regionName;
        }
        
        updateTotalChanges();
        //updateRankingByMonth();
        //updateUserRankingByMonth();
      });
    
     
  });

  function setContributorsOverviewHint() {
    var currentMonth  = $("#month-selection").children("option").filter(":selected").text(),
        currentRegion = $("#region-selection").children("option").filter(":selected").text()
    $('#overview-contributors_options').text(currentMonth + ', ' + currentRegion);
  }

function setSupportersOverviewHint() {
    var currentMonth  = $("#donate-month-selection").children("option").filter(":selected").text();
    $('#overview-supporters_options').text(currentMonth);
  }
  
function setRecipientOverviewHint() {
    var currentMonth  = $("#recipient-month-selection").children("option").filter(":selected").text();
    $('#overview-recipients_option').text(currentMonth);
  }

  $('#users-table-search').on('keyup', function() {
    reportUserDataTable.search(this.value).draw();
  });

  $('#users-table-select').on('change', function() {
    reportUserDataTable.page.len(this.value).draw();
  });

  $('#support-country-table-search').on('keyup', function() {
    reportSupportCountryDataTable.search(this.value).draw();
  });

  $('#support-country-table-select').on('change', function() {
    reportSupportCountryDataTable.page.len(this.value).draw();
  });

  $('#support-table-search').on('keyup', function() {
    reportSupportDataTable.search(this.value).draw();
  });

  $('#support-table-select').on('change', function() {
    reportSupportDataTable.page.len(this.value).draw();
  });

  $('#recipients-table-search').on('keyup', function() {
    reportRecipientsDataTable.search(this.value).draw();
  });

  $('#recipients-table-select').on('change', function() {
    reportRecipientsDataTable.page.len(this.value).draw();
  });

  $(document).on({
    //ajaxStart: function() { 
      //if (!$('#information').is(':visible')) {
        //$('.loading').addClass("active");
      //}
    //},
    ajaxStop: function() { 
      $('.loading').removeClass("active");
    }
  });
  
</script>
</body>
</html>
